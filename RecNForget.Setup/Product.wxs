<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
  <?define iconPath="..\..\..\icon_generation\logo\logo.ico"?>
  
  <!-- Set Product Id to * so we get a new guid on EVERY build (with CI now via github it makes sense not to prevent people from updating, just because you did not update the product id often enough
  ProductVersion is passed via msbuild call (proj-file)
  and then used in OutputName to rename generated file from HERE to a version string containing file name
  -->
  <Product Id="*" Name="RecNForget" Language="1033" Version="0.5.0.0" Manufacturer="DrCopyPaste" UpgradeCode="{6314EF38-B5B0-4344-92DB-C1F2B418DF70}">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" InstallPrivileges="elevated" />
    <UI>
      <UIRef Id="WixUI_InstallDir"/>
      <Publish Dialog="ExitDialog"
        Control="Finish"
        Event="DoAction"
        Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />
    <Icon Id="icon.ico" SourceFile="$(var.iconPath)" />
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />
    <Property Id="ARPHELPLINK" Value="https://github.com/DrCopyPaste/RecNForget/issues" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/DrCopyPaste/RecNForget/blob/master/README.md" />
    <Property Id="ARPURLUPDATEINFO" Value="https://github.com/DrCopyPaste/RecNForget/releases/latest" />

    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Run RecNForget now!" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
    <Property Id="WixShellExecTarget" Value="[#$(var.RecNForget.TargetFileName)]" />

    <!--<Property Id="MsiLogging" Value="v" />-->

    <!-- this should really not be needed anymore??!
    <PropertyRef Id="NETFRAMEWORK45" />
    <Condition Message="This application requires .NET Framework 4.8 or higher.">-->
      <!-- dotnet version infos: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed -->
    
    <!--
      <![CDATA[Installed OR (NETFRAMEWORK45 >= "#528040")]]>
    </Condition>

    -->

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <WixVariable Id="WixUIBannerBmp" Value="$(var.ProjectDir)..\icon_generation\installerImages\WixUIBannerBmp.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="$(var.ProjectDir)..\icon_generation\installerImages\WixUIDialogBmp.bmp" />
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)apache2.license.rtf" />

    <!-- REINSTATE this to remove app settings/autostart when uninstalling (BUT NOT when upgrading!!!)
    for removing appsettings and autostart from registry...
    <Binary Id="CustomActionDll" SourceFile="$(var.RecNForget.Setup.Extensions.TargetDir)RecNForget.Setup.Extensions.CA.dll" />
    -->


    <!-- REINSTATE this to remove app settings/autostart when uninstalling (BUT NOT when upgrading!!!)
    <InstallExecuteSequence>
      <Custom Action="RemoveApplicationSettingsCA" After="InstallFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>
    -->

    <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <!-- REINSTATE this to remove app settings/autostart when uninstalling (BUT NOT when upgrading!!!)
    <CustomAction Id="RemoveApplicationSettingsCA" Return="check" Execute="immediate" BinaryKey="CustomActionDll" DllEntry="RemoveApplicationSettings" />
    -->

    <Feature Id="ProductFeature" Title="RecNForget" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="PublishedComponents" />
    </Feature>
  </Product>
  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="MANUFACTURERFOLDER" Name="!(bind.property.Manufacturer)">
          <Directory Id="INSTALLFOLDER" Name="!(bind.property.ProductName)">
            <Directory Id="SOUNDSFOLDER" Name="Sounds" />
          </Directory>
        </Directory>
      </Directory>
      <!--
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="!(bind.property.ProductName)" />
      </Directory>
      -->
    </Directory>
  </Fragment>
  <Fragment>
    <ComponentGroup Id="ProductComponents">
      <!--
      <Component Id="$(var.RecNForget.TargetFileName)" Guid="{968CCF60-FD1A-41F1-8EB2-575C32C2F14E}" Directory="INSTALLFOLDER">
        <File Id="$(var.RecNForget.TargetFileName)" Source="$(var.RecNForget.TargetPath)" KeyPath="yes" Checksum="yes">
        </File>
        <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
      </Component>
      
      -->

      <!--
      <Component Id="ApplicationShortcuts" Guid="{3FA4885D-EC94-4023-94AE-BF49C7364D27}" Directory="ApplicationProgramsFolder">
        <Shortcut Id="ApplicationShortcut" Name="!(bind.property.ProductName)" Target="[#RecNForget.exe]" />
        <RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="ApplicationShortcutInstalled" Type="integer" Value="1" KeyPath="yes" />
        <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
      </Component>
      -->
    </ComponentGroup>
    
    <!--
    <ComponentGroup Id="ProductComponents">
      <Component Id="$(var.RecNForget.TargetFileName)" Guid="{968CCF60-FD1A-41F1-8EB2-575C32C2F14E}" Directory="INSTALLFOLDER">
        <File Id="$(var.RecNForget.TargetFileName)" Source="$(var.RecNForget.TargetPath)" KeyPath="yes" Checksum="yes">
        </File>
      </Component>

      <Component Id="FMUtils.KeyboardHook.dll" Guid="{3132874D-E3EC-49F2-A301-0D2C96A8EB01}" Directory="INSTALLFOLDER">
        <File Id="FMUtils.KeyboardHook.dll" Source="$(var.RecNForget.TargetDir)FMUtils.KeyboardHook.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="NAudio.dll" Guid="{26188527-54B5-43F6-A0FB-346FF378B5D3}" Directory="INSTALLFOLDER">
        <File Id="NAudio.dll" Source="$(var.RecNForget.TargetDir)NAudio.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="Newtonsoft.Json.dll" Guid="{D8B52782-E919-4AF6-A991-6C7E9C142578}" Directory="INSTALLFOLDER">
        <File Id="Newtonsoft.Json.dll" Source="$(var.RecNForget.TargetDir)Newtonsoft.Json.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="Octokit.dll" Guid="{F47BEBAB-7D12-4E8D-AD52-1867C344B175}" Directory="INSTALLFOLDER">
        <File Id="Octokit.dll" Source="$(var.RecNForget.TargetDir)Octokit.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="Ookii.Dialogs.Wpf.dll" Guid="{D55CCDC8-E206-4FD9-BBC6-C7CF48E947D5}" Directory="INSTALLFOLDER">
        <File Id="Ookii.Dialogs.Wpf.dll" Source="$(var.RecNForget.TargetDir)Ookii.Dialogs.Wpf.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>

      <Component Id="RecNForget.Controls.dll" Guid="{FED9B521-3CA3-47E1-BB41-CAD757CFB2AF}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.Controls.dll" Source="$(var.RecNForget.TargetDir)RecNForget.Controls.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="RecNForget.Help.dll" Guid="{F1E4FBA9-E3F0-47BC-B23B-9F4AE666E538}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.Help.dll" Source="$(var.RecNForget.TargetDir)RecNForget.Help.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="RecNForget.IoC.dll" Guid="{2E11E940-E850-4A98-90F3-66026963356C}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.IoC.dll" Source="$(var.RecNForget.TargetDir)RecNForget.IoC.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="RecNForget.Services.Contracts.dll" Guid="{D77E4596-72F8-48A8-ADFA-1A75BC9BDB26}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.Services.Contracts.dll" Source="$(var.RecNForget.TargetDir)RecNForget.Services.Contracts.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="RecNForget.Services.Designer.dll" Guid="{21B31333-4A77-4080-B9E7-F6DA115DFE0A}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.Services.Designer.dll" Source="$(var.RecNForget.TargetDir)RecNForget.Services.Designer.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="RecNForget.Services.dll" Guid="{B5460FEA-F566-4FAD-B516-0EE3EFF7CA10}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.Services.dll" Source="$(var.RecNForget.TargetDir)RecNForget.Services.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="RecNForget.Services.Helpers.dll" Guid="{B1C752E0-4A3C-4164-8775-03FB93A549F0}" Directory="INSTALLFOLDER">
        <File Id="RecNForget.Services.Helpers.dll" Source="$(var.RecNForget.TargetDir)RecNForget.Services.Helpers.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="System.Runtime.CompilerServices.Unsafe.dll" Guid="{5F4909CC-96E6-4CAE-8CD9-AFCE1E51DD6A}" Directory="INSTALLFOLDER">
        <File Id="System.Runtime.CompilerServices.Unsafe.dll" Source="$(var.RecNForget.TargetDir)System.Runtime.CompilerServices.Unsafe.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="Unity.Abstractions.dll" Guid="{98233AE3-5C6C-4407-AECC-E44AA7BABA73}" Directory="INSTALLFOLDER">
        <File Id="Unity.Abstractions.dll" Source="$(var.RecNForget.TargetDir)Unity.Abstractions.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="Unity.Container.dll" Guid="{C6C9C2F8-B30E-4739-AABB-71541581E0F3}" Directory="INSTALLFOLDER">
        <File Id="Unity.Container.dll" Source="$(var.RecNForget.TargetDir)Unity.Container.dll" KeyPath="yes" Checksum="yes">
        </File>
      </Component>
      <Component Id="startRec.wav" Guid="{D3278C12-118D-4801-B89E-25FC728C3F34}" Directory="SOUNDSFOLDER">
        <File Id="startRec.wav" Source="$(var.RecNForget.TargetDir)Sounds\startRec.wav" KeyPath="yes" Checksum="yes" />
      </Component>
      <Component Id="stopRec.wav" Guid="{43FD0758-553C-4A7E-8FAA-CAED1E4FDCB7}" Directory="SOUNDSFOLDER">
        <File Id="stopRec.wav" Source="$(var.RecNForget.TargetDir)Sounds\stopRec.wav" KeyPath="yes" Checksum="yes" />
      </Component>
      <Component Id="playbackStart.wav" Guid="{C398530A-DC91-4569-BE9A-FD55C47E4660}" Directory="SOUNDSFOLDER">
        <File Id="playbackStart.wav" Source="$(var.RecNForget.TargetDir)Sounds\playbackStart.wav" KeyPath="yes" Checksum="yes" />
      </Component>
      <Component Id="playbackStop.wav" Guid="{EE3C9B53-A281-4C57-9A0F-9535859341B1}" Directory="SOUNDSFOLDER">
        <File Id="playbackStop.wav" Source="$(var.RecNForget.TargetDir)Sounds\playbackStop.wav" KeyPath="yes" Checksum="yes" />
      </Component>
      <Component Id="ApplicationShortcuts" Guid="{3FA4885D-EC94-4023-94AE-BF49C7364D27}" Directory="ApplicationProgramsFolder">
        <Shortcut Id="ApplicationShortcut" Name="!(bind.property.ProductName)" Target="[#RecNForget.exe]" />
        <RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="ApplicationShortcutInstalled" Type="integer" Value="1" KeyPath="yes" />
        <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
      </Component>
    </ComponentGroup>
    -->
  </Fragment>
</Wix>